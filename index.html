<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–õ–ê–ë–ò–†–ò–ù–¢ –í–û–ò–ù - STANDALONE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: black; margin: 0; overflow: hidden; user-select: none; touch-action: none; }
        canvas { display: block; width: 100vw; height: 100vh; cursor: crosshair; }
        .dpad-btn { width: 70px; height: 70px; background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.3); border-radius: 15px; display: flex; items-center: center; justify-content: center; color: white; font-size: 24px; font-weight: bold; }
        .dpad-btn:active { background: rgba(16, 185, 129, 0.5); border-color: #10b981; }
    </style>
</head>
<body>
    <video id="video" style="display:none" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>

    <!-- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ -->
    <div id="menu" class="fixed inset-0 z-[2000] bg-white flex flex-col items-center justify-between p-12 text-black">
        <h1 class="text-5xl md:text-8xl font-black uppercase mt-12 text-center leading-none tracking-tighter">–õ–ê–ë–ò–†–ò–ù–¢<br>–í–û–ò–ù</h1>
        <div class="flex flex-row items-center justify-center gap-6 w-full">
            <button onclick="showSkins()" class="w-24 h-48 md:w-56 md:h-96 rounded-[60px] bg-[#00a8f3] border-[8px] border-black text-2xl font-black shadow-[10px_10px_0_black] active:translate-y-2 transition-all uppercase -rotate-6">—Å–∫–∏–Ω—ã</button>
            <button onclick="startGame(false)" class="w-56 h-56 md:w-96 md:h-96 bg-[#ed1c24] border-[10px] border-black rounded-[50px] text-5xl md:text-8xl font-black shadow-[15px_15px_0_black] active:translate-y-2 transition-all uppercase scale-110 z-10">–∏–≥—Ä–∞—Ç—å</button>
            <button onclick="startGame(true)" class="w-24 h-48 md:w-56 md:h-96 rounded-[60px] bg-[#3f48cc] border-[8px] border-black text-xl font-black shadow-[10px_10px_0_black] active:translate-y-2 transition-all uppercase rotate-6 text-center px-4">—Ä–µ–¥–∞–∫—Ç–æ—Ä</button>
        </div>
        <div class="mb-4 font-bold text-gray-400">v2.1.0-fixed</div>
    </div>

    <!-- –ú–ï–ù–Æ –°–ö–ò–ù–û–í -->
    <div id="skins" class="fixed inset-0 z-[2100] bg-white hidden flex-col items-center justify-center p-12 text-black space-y-10">
        <button onclick="showMenu()" class="absolute top-8 left-8 flex items-center gap-2 font-black uppercase text-2xl">‚Üê –Ω–∞–∑–∞–¥</button>
        <h2 class="text-6xl font-black uppercase">–í–´–ë–ï–†–ò –°–ö–ò–ù</h2>
        <div id="skin-preview" class="w-64 h-64 border-[12px] border-black bg-gray-100 flex items-center justify-center overflow-hidden shadow-[15px_15px_0_black]">
            <div id="skin-rect" class="w-full h-full bg-[#10b981]"></div>
        </div>
        <div class="grid grid-cols-4 gap-6" id="skin-list"></div>
        <button onclick="document.getElementById('fileInput').click()" class="bg-black text-white px-20 py-8 text-3xl font-black uppercase rounded-none shadow-[12px_12px_0_#666] active:translate-y-2 transition-all">+ —Å–≤–æ–π —Å–∫–∏–Ω</button>
        <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="loadCustomSkin(event)">
    </div>

    <!-- –ò–ù–¢–ï–†–§–ï–ô–° –ò–ì–†–´ -->
    <div id="game-ui" class="hidden pointer-events-none absolute inset-0">
        <div class="absolute top-4 left-4 z-50 flex flex-col gap-4 pointer-events-auto">
            <button onclick="showSettings()" class="bg-[#10b981] text-black px-8 py-4 rounded-2xl font-black uppercase text-2xl shadow-[0_8px_0_#059669] active:translate-y-1 active:shadow-none transition-all">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            <div id="lvl-display" class="bg-black/80 border-4 border-[#10b981] text-[#10b981] px-6 py-3 rounded-2xl font-black text-2xl shadow-xl text-center">–£–†–û–í–ï–ù–¨: 1</div>
        </div>

        <!-- –ú–û–ë–ò–õ–¨–ù–´–ô –î–ñ–û–ô–°–¢–ò–ö -->
        <div id="mobile-dpad" class="absolute bottom-10 left-10 z-50 grid grid-cols-3 gap-2 pointer-events-auto hidden">
            <div></div>
            <button class="dpad-btn" onpointerdown="game.keys['w']=true" onpointerup="game.keys['w']=false" onpointerleave="game.keys['w']=false">‚ñ≤</button>
            <div></div>
            <button class="dpad-btn" onpointerdown="game.keys['a']=true" onpointerup="game.keys['a']=false" onpointerleave="game.keys['a']=false">‚óÄ</button>
            <button class="dpad-btn" onpointerdown="game.keys['s']=true" onpointerup="game.keys['s']=false" onpointerleave="game.keys['s']=false">‚ñº</button>
            <button class="dpad-btn" onpointerdown="game.keys['d']=true" onpointerup="game.keys['d']=false" onpointerleave="game.keys['d']=false">‚ñ∂</button>
        </div>
    </div>

    <!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
    <div id="settings" class="fixed inset-0 z-[3000] hidden items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-[#111] border-[6px] border-[#10b981] rounded-[40px] p-10 w-[400px] space-y-8 text-white shadow-[0_0_50px_rgba(16,185,129,0.5)]">
            <h3 class="text-4xl font-black text-center uppercase tracking-widest">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <div class="grid grid-cols-2 gap-4">
                <button id="btn-pc" onclick="setControl('pc')" class="py-4 rounded-2xl font-black uppercase border-4 border-[#10b981] bg-[#10b981] text-black">üíª –ü–ö</button>
                <button id="btn-mob" onclick="setControl('mob')" class="py-4 rounded-2xl font-black uppercase border-4 border-white/20">üì± –ú–û–ë.</button>
            </div>
            <button onclick="openAmir()" class="w-full h-20 bg-[#f0f] text-white font-black uppercase rounded-3xl text-2xl shadow-[0_10px_0_#b0b] active:translate-y-1 active:shadow-none transition-all">by:–¥–∞–Ω–∏–∏–ª</button>
            <div class="flex gap-4">
                <button onclick="toMainMenu()" class="flex-1 py-4 bg-red-600 rounded-2xl font-black uppercase text-white shadow-[0_6px_0_#991b1b]">–í –ú–µ–Ω—é</button>
                <button onclick="closeSettings()" class="flex-1 py-4 bg-white/10 rounded-2xl font-black uppercase text-white border-2 border-white/20">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ê–ú–ò–† –ü–ê–ù–ï–õ–¨ -->
    <div id="amir" class="fixed inset-0 z-[4000] hidden items-center justify-center bg-black/90 p-4">
        <div class="border-[6px] border-[#f0f] rounded-[50px] p-8 w-full max-w-[450px] flex flex-col gap-6 bg-[#111] text-[#f0f] shadow-[0_0_40px_#f0f]">
            <h3 class="text-5xl font-black text-center uppercase italic">–ê–ú–ò–† –ü–ê–ù–ï–õ–¨</h3>
            <div class="grid grid-cols-2 gap-4" id="amir-buttons">
                <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±—É–¥—É—Ç —Ç—É—Ç -->
            </div>
            <div class="flex gap-4">
                <button onclick="document.getElementById('blockInput').click()" class="flex-1 h-16 bg-[#00a8f3] text-white font-black uppercase rounded-2xl text-xl shadow-[0_6px_0_#0084c2] active:translate-y-1 active:shadow-none transition-all">+ –°–í–û–ô –ë–õ–û–ö</button>
                <button onclick="clearMap()" class="flex-1 h-16 bg-red-600 text-white font-black uppercase rounded-2xl text-xl shadow-[0_6px_0_#991b1b] active:translate-y-1 active:shadow-none transition-all">–£–î–ê–õ–ò–¢–¨ –í–°–Å</button>
            </div>
            <input type="file" id="blockInput" class="hidden" accept="image/*" onchange="createCustomBlock(event)">
            
            <div class="grid grid-cols-4 gap-2 bg-black/70 p-4 rounded-[30px] border-4 border-white/10 overflow-y-auto max-h-[200px]" id="block-selector">
                <!-- –í—ã–±–æ—Ä –±–ª–æ–∫–æ–≤ -->
            </div>
            <button onclick="closeAmir()" class="w-full h-16 bg-white/10 text-white rounded-2xl uppercase font-black text-xl border-2 border-white/20">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- –ú–ï–ù–Æ –ü–û–í–ï–î–ï–ù–ò–Ø –ë–õ–û–ö–ê -->
    <div id="behavior-menu" class="fixed inset-0 z-[5000] hidden items-center justify-center bg-black/95">
        <div class="bg-white p-10 rounded-[40px] w-[350px] flex flex-col gap-4 text-black text-center">
            <h4 class="text-2xl font-black uppercase">–ö–ê–ö –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨?</h4>
            <button onclick="selectBehavior(1)" class="py-4 bg-gray-200 rounded-2xl font-bold uppercase hover:bg-black hover:text-white transition-all">1. –ö–ê–ö –°–¢–ï–ù–£</button>
            <button onclick="selectBehavior(200)" class="py-4 bg-gray-200 rounded-2xl font-bold uppercase hover:bg-black hover:text-white transition-all">2. –ö–ê–ö –ö–û–ù–ï–¶</button>
            <button onclick="selectBehavior(2)" class="py-4 bg-gray-200 rounded-2xl font-bold uppercase hover:bg-black hover:text-white transition-all">3. –ö–ê–ö –°–õ–û–ú–ê–ù–ù–´–ô</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('video');

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ
        let state = 'menu';
        let currentLvl = 1;
        let isBuild = false;
        let isNoClip = false;
        let isFog = true;
        let isCam = false;
        let skinColor = '#10b981';
        let skinImg = null;
        let selB = 1;
        let controlType = 'pc';

        // –ê—Å—Å–µ—Ç—ã
        const assets = {};
        const audios = { menu: null, step: null, ghost: null, panel: null };
        const textures = ['wall.png', 'floor.png', 'door.png', 'crack.png', 'btn_build.png', 'btn_ghost.png', 'btn_fog.png', 'btn_cam.png'];
        
        textures.forEach(t => {
            const img = new Image();
            img.src = 'assets/' + t;
            assets[t] = img;
        });

        function loadAudio() {
            audios.menu = new Audio('assets/menu.mp3'); audios.menu.loop = true;
            audios.step = new Audio('assets/step.mp3'); audios.step.loop = true; audios.step.volume = 0.5;
            audios.ghost = new Audio('assets/ghost.mp3'); audios.ghost.loop = true;
            audios.panel = new Audio('assets/panel.mp3');
        }
        loadAudio();

        let audioUnlocked = false;
        function unlockAudio() {
            if (audioUnlocked) return;
            audioUnlocked = true;
            Object.values(audios).forEach(a => { if (a) { a.play().then(() => { if (a !== audios.menu || state !== 'menu') { a.pause(); a.currentTime = 0; } }).catch(() => {}); } });
            if (state === 'menu' && audios.menu) audios.menu.play().catch(() => {});
        }
        window.addEventListener('click', unlockAudio, { once: true });
        window.addEventListener('touchstart', unlockAudio, { once: true });

        // –ò–≥—Ä–∞
        const game = {
            player: { x: 1.5, y: 1.5, r: 0.3 },
            map: [],
            size: 21,
            keys: {},
            inWall: false
        };

        function genMaze(s) {
            const m = Array.from({ length: s }, () => Array(s).fill(1));
            const walk = (x, y) => {
                m[y][x] = 0;
                const d = [[0,-2],[0,2],[-2,0],[2,0]].sort(() => Math.random()-0.5);
                for (const [dx, dy] of d) {
                    const nx=x+dx, ny=y+dy;
                    if (nx>0 && nx<s-1 && ny>0 && ny<s-1 && m[ny][nx]===1) {
                        m[y+dy/2][x+dx/2] = Math.random()<0.1 ? 2 : 0;
                        walk(nx, ny);
                    }
                }
            };
            walk(1, 1);
            m[s-2][s-2] = 200;
            return m;
        }

        function startGame(build) {
            state = 'playing';
            isBuild = build;
            currentLvl = 1;
            game.size = 21;
            game.map = genMaze(game.size);
            game.player = { x: 1.5, y: 1.5, r: 0.3 };
            document.getElementById('menu').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            if (audios.menu) audios.menu.pause();
            renderAmir();
        }

        function clearMap() {
            if (!confirm('–¢–û–ß–ù–û –£–î–ê–õ–ò–¢–¨ –í–°–Å?')) return;
            for (let y = 0; y < game.size; y++) {
                for (let x = 0; x < game.size; x++) {
                    // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ä–∞–º–∫—É –∏–∑ —Å—Ç–µ–Ω, –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî –≤ 0
                    if (x === 0 || x === game.size - 1 || y === 0 || y === game.size - 1) {
                        game.map[y][x] = 1;
                    } else {
                        game.map[y][x] = 0;
                    }
                }
            }
            alert('–ö–ê–†–¢–ê –û–ß–ò–©–ï–ù–ê!');
        }

        function setControl(type) {
            controlType = type;
            document.getElementById('btn-pc').className = type === 'pc' ? 'py-4 rounded-2xl font-black uppercase border-4 border-[#10b981] bg-[#10b981] text-black' : 'py-4 rounded-2xl font-black uppercase border-4 border-white/20';
            document.getElementById('btn-mob').className = type === 'mob' ? 'py-4 rounded-2xl font-black uppercase border-4 border-[#10b981] bg-[#10b981] text-black' : 'py-4 rounded-2xl font-black uppercase border-4 border-white/20';
            document.getElementById('mobile-dpad').classList.toggle('hidden', type === 'pc');
        }

        function showSkins() { state = 'skins'; document.getElementById('menu').style.display = 'none'; document.getElementById('skins').style.display = 'flex'; }
        function showMenu() { state = 'menu'; document.getElementById('skins').style.display = 'none'; document.getElementById('menu').style.display = 'flex'; if (audios.menu) audios.menu.play(); }
        function showSettings() { document.getElementById('settings').style.display = 'flex'; }
        function closeSettings() { document.getElementById('settings').style.display = 'none'; }
        function openAmir() { document.getElementById('amir').style.display = 'flex'; if (audios.panel) audios.panel.play().catch(() => {}); renderAmir(); }
        function closeAmir() { document.getElementById('amir').style.display = 'none'; }
        function toMainMenu() { location.reload(); }

        // –ö–∞—Å—Ç–æ–º–Ω—ã–µ –±–ª–æ–∫–∏
        let tempBlockImg = null;
        let nextCustomId = 300;
        const CUSTOM_BLOCKS = [];

        function createCustomBlock(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (re) => {
                const img = new Image();
                img.src = re.target.result;
                tempBlockImg = img;
                document.getElementById('behavior-menu').style.display = 'flex';
            };
            reader.readAsDataURL(file);
        }

        function selectBehavior(bh) {
            const id = nextCustomId++;
            CUSTOM_BLOCKS.push({ id, type: bh, img: tempBlockImg });
            selB = id;
            document.getElementById('behavior-menu').style.display = 'none';
            renderAmir();
        }

        function loadCustomSkin(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (re) => {
                const img = new Image();
                img.src = re.target.result;
                skinImg = img;
                document.getElementById('skin-preview').innerHTML = `<img src="${img.src}" class="w-full h-full object-cover">`;
            };
            reader.readAsDataURL(file);
        }

        function loop() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if (state === 'playing' && document.getElementById('settings').style.display === 'none') update();
            draw();
            requestAnimationFrame(loop);
        }

        function update() {
            let vx = 0, vy = 0;
            const speed = 0.15;
            if (game.keys['w']) vy = -speed;
            if (game.keys['s']) vy = speed;
            if (game.keys['a']) vx = -speed;
            if (game.keys['d']) vx = speed;

            const check = (nx, ny) => {
                const r = game.player.r;
                const pts = [[nx-r,ny-r],[nx+r,ny-r],[nx-r,ny+r],[nx+r,ny+r]];
                let collision = false;
                for (const [px, py] of pts) {
                    const bx = Math.floor(px), by = Math.floor(py);
                    let id = game.map[by]?.[bx];
                    let behavior = id;
                    
                    if (id >= 300) {
                        const cb = CUSTOM_BLOCKS.find(b => b.id === id);
                        behavior = cb ? cb.type : 0;
                    }

                    if (behavior === 1) {
                        collision = true;
                        if (!isNoClip) return false;
                    }
                    if (behavior === 2) { 
                        if (!isNoClip) game.map[by][bx] = 0; 
                        return true; 
                    }
                    if (behavior === 200) { 
                        currentLvl++; 
                        game.map = genMaze(game.size += 4); 
                        game.player = {x:1.5,y:1.5,r:0.3}; 
                        document.getElementById('lvl-display').innerText = '–£–†–û–í–ï–ù–¨: ' + currentLvl; 
                        return false; 
                    }
                }
                game.inWall = collision;
                return true;
            };

            if (check(game.player.x + vx, game.player.y)) game.player.x += vx;
            if (check(game.player.x, game.player.y + vy)) game.player.y += vy;

            if (audioUnlocked) {
                const moving = Math.abs(vx) > 0 || Math.abs(vy) > 0;
                if (moving) {
                    if (isNoClip) {
                        audios.step.pause();
                        if (game.inWall) { if (audios.ghost.paused) audios.ghost.play().catch(()=>{}); }
                        else audios.ghost.pause();
                    } else {
                        audios.ghost.pause();
                        if (audios.step.paused) audios.step.play().catch(()=>{});
                    }
                } else {
                    audios.step.pause();
                    audios.ghost.pause();
                }
            }
        }

        function draw() {
            if (state !== 'playing') return;
            if (isCam && video.srcObject) {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(0,0,canvas.width,canvas.height);
            } else {
                ctx.fillStyle = 'black'; ctx.fillRect(0,0,canvas.width,canvas.height);
            }

            const ts = Math.min(canvas.width, canvas.height) / 8;
            const ox = canvas.width / 2 - game.player.x * ts;
            const oy = canvas.height / 2 - game.player.y * ts;

            for (let y = Math.floor(game.player.y - 10); y < game.player.y + 10; y++) {
                for (let x = Math.floor(game.player.x - 10); x < game.player.x + 10; x++) {
                    if (y>=0 && x>=0 && y<game.size && x<game.size) {
                        const id = game.map[y][x];
                        const f = assets['floor.png'];
                        if (f && f.complete && f.naturalWidth > 0) ctx.drawImage(f, ox+x*ts, oy+y*ts, ts+1, ts+1);
                        else { ctx.fillStyle = '#111'; ctx.fillRect(ox+x*ts, oy+y*ts, ts+1, ts+1); }

                        if (id === 1) {
                            const w = assets['wall.png'];
                            if (w && w.complete && w.naturalWidth > 0) ctx.drawImage(w, ox+x*ts, oy+y*ts, ts, ts);
                            else { ctx.fillStyle = '#444'; ctx.fillRect(ox+x*ts, oy+y*ts, ts, ts); }
                        } else if (id === 2) {
                            const c = assets['crack.png'];
                            if (c && c.complete && c.naturalWidth > 0) ctx.drawImage(c, ox+x*ts, oy+y*ts, ts, ts);
                            else { ctx.fillStyle = '#8b4513'; ctx.fillRect(ox+x*ts, oy+y*ts, ts, ts); }
                        } else if (id === 200) {
                            const d = assets['door.png'];
                            if (d && d.complete && d.naturalWidth > 0) ctx.drawImage(d, ox+x*ts, oy+y*ts, ts, ts);
                            else { ctx.fillStyle = 'gold'; ctx.fillRect(ox+x*ts, oy+y*ts, ts, ts); }
                        } else if (id >= 300) {
                            const cb = CUSTOM_BLOCKS.find(b => b.id === id);
                            if (cb && cb.img) ctx.drawImage(cb.img, ox+x*ts, oy+y*ts, ts, ts);
                        }
                    }
                }
            }

            if (skinImg) ctx.drawImage(skinImg, canvas.width/2 - ts*0.3, canvas.height/2 - ts*0.3, ts*0.6, ts*0.6);
            else { ctx.fillStyle = skinColor; ctx.fillRect(canvas.width/2 - ts*0.3, canvas.height/2 - ts*0.3, ts*0.6, ts*0.6); }

            if (isFog) {
                const g = ctx.createRadialGradient(canvas.width/2, canvas.height/2, ts, canvas.width/2, canvas.height/2, ts*5);
                g.addColorStop(0, 'transparent'); g.addColorStop(1, 'rgba(0,0,0,0.9)');
                ctx.fillStyle = g; ctx.fillRect(0,0,canvas.width,canvas.height);
            }
        }

        const PREDEFINED_SKINS = [
            { color: '#10b981' }, { color: '#3b82f6' }, { color: '#ef4444' }, { color: '#f1c40f' }, { color: '#8e44ad' }, { color: '#e67e22' }
        ];
        const skinList = document.getElementById('skin-list');
        PREDEFINED_SKINS.forEach(s => {
            const btn = document.createElement('button');
            btn.className = "w-20 h-20 border-4 border-black shadow-[4px_4px_0_black]";
            btn.style.backgroundColor = s.color;
            btn.onclick = () => { skinColor = s.color; skinImg = null; document.getElementById('skin-preview').innerHTML = `<div class="w-full h-full" style="background:${s.color}"></div>`; };
            skinList.appendChild(btn);
        });

        function renderAmir() {
            const btns = document.getElementById('amir-buttons');
            btns.innerHTML = '';
            const controls = [
                { name: '–°–¢–†–û–ô–ö–ê', state: isBuild, asset: 'btn_build.png', toggle: () => isBuild = !isBuild },
                { name: '–ü–†–ò–ó–†–ê–ö', state: isNoClip, asset: 'btn_ghost.png', toggle: () => isNoClip = !isNoClip },
                { name: '–¢–£–ú–ê–ù', state: !isFog, asset: 'btn_fog.png', toggle: () => isFog = !isFog },
                { name: '–ö–ê–ú–ï–†–ê', state: isCam, asset: 'btn_cam.png', toggle: () => {
                    isCam = !isCam; if (isCam) navigator.mediaDevices.getUserMedia({ video: true }).then(s => video.srcObject = s).catch(() => isCam = false);
                }}
            ];
            controls.forEach(c => {
                const b = document.createElement('button');
                b.className = `h-16 rounded-2xl font-black uppercase border-4 transition-all ${c.state ? 'bg-[#10b981] border-[#10b981] text-black' : 'bg-white/5 border-white/20 text-white'}`;
                b.innerText = c.name; b.onclick = () => { c.toggle(); renderAmir(); };
                btns.appendChild(b);
            });

            const selector = document.getElementById('block-selector');
            selector.innerHTML = '';
            const defaults = [
                { id: 1, col: '#444', asset: 'wall.png' },
                { id: 2, col: '#8b4513', asset: 'crack.png' },
                { id: 200, col: 'gold', asset: 'door.png' },
                { id: 0, col: '#000', asset: 'floor.png' }
            ];
            [...defaults, ...CUSTOM_BLOCKS].forEach(b => {
                const btn = document.createElement('button');
                btn.className = `aspect-square rounded-xl border-4 ${selB === b.id ? 'border-[#10b981]' : 'border-transparent'} overflow-hidden bg-black`;
                if (b.img) btn.innerHTML = `<img src="${b.img.src}" class="w-full h-full object-cover">`;
                else if (b.asset && assets[b.asset] && assets[b.asset].complete) btn.innerHTML = `<img src="${assets[b.asset].src}" class="w-full h-full object-cover">`;
                else btn.style.backgroundColor = b.col || '#333';
                btn.onclick = () => { selB = b.id; renderAmir(); };
                selector.appendChild(btn);
            });
        }

        window.onkeydown = (e) => {
            const k = e.key.toLowerCase();
            if (k === 'w' || k === '—Ü') game.keys['w'] = true;
            if (k === 's' || k === '—ã') game.keys['s'] = true;
            if (k === 'a' || k === '—Ñ') game.keys['a'] = true;
            if (k === 'd' || k === '–≤') game.keys['d'] = true;
            if (k.startsWith('arrow')) {
                if (k === 'arrowup') game.keys['w'] = true;
                if (k === 'arrowdown') game.keys['s'] = true;
                if (k === 'arrowleft') game.keys['a'] = true;
                if (k === 'arrowright') game.keys['d'] = true;
            }
        };
        window.onkeyup = (e) => {
            const k = e.key.toLowerCase();
            if (k === 'w' || k === '—Ü') game.keys['w'] = false;
            if (k === 's' || k === '—ã') game.keys['s'] = false;
            if (k === 'a' || k === '—Ñ') game.keys['a'] = false;
            if (k === 'd' || k === '–≤') game.keys['d'] = false;
            if (k.startsWith('arrow')) {
                if (k === 'arrowup') game.keys['w'] = false;
                if (k === 'arrowdown') game.keys['s'] = false;
                if (k === 'arrowleft') game.keys['a'] = false;
                if (k === 'arrowright') game.keys['d'] = false;
            }
        };
        
        canvas.onpointerdown = (e) => {
            if (!isBuild || e.target !== canvas) return;
            const ts = Math.min(canvas.width, canvas.height) / 8;
            const ox = canvas.width / 2 - game.player.x * ts;
            const oy = canvas.height / 2 - game.player.y * ts;
            const mx = Math.floor((e.clientX - ox) / ts);
            const my = Math.floor((e.clientY - oy) / ts);
            if (my >= 0 && my < game.size && mx >= 0 && mx < game.size) game.map[my][mx] = selB;
        };

        requestAnimationFrame(loop);
    </script>
</body>
</html>