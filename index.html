
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maze Warrior - Amir Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #fff; font-family: 'Inter', sans-serif; user-select: none; }
        canvas { display: block; background: #000; }
        
        .ui-layer { position: fixed; inset: 0; pointer-events: none; z-index: 100; }
        .ui-layer * { pointer-events: auto; }

        /* –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é */
        #main-menu { position: fixed; inset: 0; background: #fff; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 50px 20px; z-index: 2000; }
        .menu-title { font-size: 50px; font-weight: 900; text-align: center; line-height: 0.9; text-transform: uppercase; margin-top: 40px; }
        .menu-buttons { display: flex; align-items: center; gap: 20px; width: 100%; max-width: 600px; justify-content: center; }
        .btn { border: 8px solid #000; font-weight: 900; text-transform: uppercase; cursor: pointer; transition: 0.1s; box-shadow: 8px 8px 0 #000; display: flex; align-items: center; justify-content: center; text-align: center; }
        .btn:active { transform: translate(4px, 4px); box-shadow: none; }
        .btn-play { width: 180px; height: 180px; background: #ed1c24; border-radius: 40px; font-size: 32px; z-index: 2; transform: scale(1.1); }
        .btn-side { width: 100px; height: 200px; border-radius: 60px; font-size: 18px; }
        .btn-skins { background: #00a8f3; transform: rotate(-6deg); }
        .btn-build { background: #3f48cc; transform: rotate(6deg); }

        /* –ê–º–∏—Ä –ü–∞–Ω–µ–ª—å */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .modal-content { background: #111; border: 4px solid #10b981; border-radius: 32px; padding: 30px; width: 90%; max-width: 380px; color: #10b981; display: flex; flex-direction: column; gap: 15px; }
        .modal-title { font-size: 28px; font-weight: 900; text-align: center; text-transform: uppercase; margin-bottom: 10px; }
        .amir-btn { width: 100%; height: 55px; border-radius: 15px; border: none; font-weight: 900; text-transform: uppercase; cursor: pointer; color: #fff; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .amir-btn img { width: 100%; height: 100%; object-fit: contain; }
        .btn-green { background: #10b981; color: #000; }
        .btn-red { background: #ed1c24; }
        .btn-purple { background: #9b59b6; }
        .btn-orange { background: #e67e22; }
        
        .block-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; background: rgba(0,0,0,0.5); padding: 15px; border-radius: 20px; max-height: 200px; overflow-y: auto; }
        .block-item { aspect-ratio: 1; border: 3px solid transparent; border-radius: 10px; overflow: hidden; cursor: pointer; background: #333; }
        .block-item.active { border-color: #10b981; }
        .block-item img { width: 100%; height: 100%; object-fit: cover; }

        /* –ò–≥—Ä–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        .game-hud { position: absolute; top: 20px; left: 20px; display: flex; flex-direction: column; gap: 10px; }
        .lvl-badge { background: rgba(0,0,0,0.8); border: 2px solid #10b981; color: #10b981; padding: 8px 15px; border-radius: 12px; font-weight: 900; }
        .btn-settings { background: rgba(0,0,0,0.8); border: 2px solid #10b981; color: #10b981; padding: 8px 15px; border-radius: 12px; font-weight: 900; text-transform: uppercase; cursor: pointer; }

        /* –î–∂–æ–π—Å—Ç–∏–∫ */
        #joystick-base { position: fixed; bottom: 50px; left: 50px; width: 120px; height: 120px; background: rgba(0,0,0,0.3); border: 3px solid rgba(16,185,129,0.4); border-radius: 60px; display: none; }
        #joystick-stick { position: absolute; top: 35px; left: 35px; width: 50px; height: 50px; background: #10b981; border-radius: 25px; }

        /* –°–∫–∏–Ω—ã */
        #skins-menu { position: fixed; inset: 0; background: #fff; z-index: 2500; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 40px; gap: 20px; }
        .skin-preview { width: 150px; height: 150px; border: 8px solid #000; background: #eee; box-shadow: 10px 10px 0 #000; display: flex; align-items: center; justify-content: center; }
        .skin-preview img { width: 100%; height: 100%; object-fit: cover; }
        .skin-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .skin-option { width: 60px; height: 60px; border: 4px solid #000; box-shadow: 4px 4px 0 #000; cursor: pointer; overflow: hidden; }
        .skin-option img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

    <div id="main-menu">
        <div style="color: #aaa; font-weight: 900;">BETA v1.2.7</div>
        <div class="menu-title">–ò–ì–†–ê –ü–†–û<br>–õ–ê–ë–ò–†–ò–ù–¢–´</div>
        <div class="menu-buttons">
            <div class="btn btn-side btn-skins" onclick="showSkins()">–°–∫–∏–Ω—ã</div>
            <div class="btn btn-play" onclick="startGame(false)">–ò–≥—Ä–∞—Ç—å</div>
            <div class="btn btn-side btn-build" onclick="startGame(true)">–°–æ–∑–¥–∞—Ç—å</div>
        </div>
        <div style="font-weight: 900; color: #ccc;">2024 Maze Dev</div>
    </div>

    <div id="skins-menu">
        <div onclick="showMenu()" style="position: absolute; top: 30px; left: 30px; font-weight: 900; cursor: pointer;">‚Üê –ù–ê–ó–ê–î</div>
        <div class="menu-title">–í–´–ë–ï–†–ò –°–ö–ò–ù</div>
        <div class="skin-preview" id="current-skin-preview"></div>
        <div class="skin-grid" id="skin-grid"></div>
        <button class="btn" style="padding: 15px 40px; border-radius: 0; background: #000; color: #fff;" onclick="document.getElementById('file-input').click()">–°–≤–æ–π —Å–∫–∏–Ω</button>
        <input type="file" id="file-input" hidden accept="image/*" onchange="loadCustomSkin(event)">
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="amir-btn btn-green" onclick="setMode('pc')">üíª –ü–ö</button>
                <button class="amir-btn btn-green" onclick="setMode('mob')">üì± –ú–û–ë.</button>
            </div>
            <button class="amir-btn btn-green" onclick="showAmir()">üë§ BY:–î–ê–ù–ò–ò–õ</button>
            <div style="display: flex; gap: 10px;">
                <button class="amir-btn btn-red" onclick="location.reload()">–í –ú–µ–Ω—é</button>
                <button class="amir-btn" style="background: #333;" onclick="closeModals()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="amir-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">–ê–º–∏—Ä –ü–∞–Ω–µ–ª—å</div>
            <button id="btn-toggle-build" class="amir-btn btn-red" onclick="toggleBuild()">–°–¢–†–û–ô–ö–ê: –í–´–ö–õ</button>
            <button id="btn-toggle-ghost" class="amir-btn btn-purple" onclick="toggleGhost()">–ü–†–ò–ó–†–ê–ö: –í–´–ö–õ</button>
            <button id="btn-toggle-fog" class="amir-btn btn-orange" onclick="toggleFog()">–¢–£–ú–ê–ù: –í–ö–õ</button>
            <div class="block-grid" id="block-grid"></div>
            <button class="amir-btn" style="background: #333;" onclick="showSettings()">–ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <div id="game-ui" style="display: none;" class="ui-layer">
        <div class="game-hud">
            <div class="lvl-badge" id="lvl-display">–£–†–û–í–ï–ù–¨: 1</div>
            <button class="btn-settings" onclick="showSettings()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>
        <div id="joystick-base"><div id="joystick-stick"></div></div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let state = 'menu';
        let level = 1;
        let isBuild = false;
        let isGhost = false;
        let isFog = true;
        let isMobile = false;
        let selectedBlock = 1;
        let audioUnlocked = false;

        const assets = {};
        const audio = { menu: null, step: null };
        const game = {
            player: { x: 1.5, y: 1.5, r: 0.3 },
            map: [],
            size: 21,
            joy: { x: 0, y: 0 },
            keys: {}
        };

        const B_TYPES = [
            { id: 1, name: '–°—Ç–µ–Ω–∞', col: '#444', img: 'wall.png' },
            { id: 2, name: '–¢—Ä–µ—â–∏–Ω–∞', col: '#8b4513', img: 'crack.png' },
            { id: 101, name: '–°–µ–∫—Ä–µ—Ç 1', col: '#f0f', img: 'secret1.png' },
            { id: 102, name: '–°–µ–∫—Ä–µ—Ç 2', col: '#0ff', img: 'secret2.png' },
            { id: 103, name: '–°–µ–∫—Ä–µ—Ç 3', col: '#ff0', img: 'secret3.png' },
            { id: 0, name: '–ü–æ–ª', col: '#222', img: 'floor.png' }
        ];

        const SKINS = [
            { id: 'skin1', asset: 'skin1.png', color: '#10b981' },
            { id: 'skin2', asset: 'skin2.png', color: '#3b82f6' },
            { id: 'skin3', asset: 'skin3.png', color: '#ef4444' },
            { id: 'skin4', asset: 'skin4.png', color: '#f1c40f' }
        ];
        let currentSkinImg = null;
        let currentSkinColor = '#10b981';

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Å—Å–µ—Ç–æ–≤
        const fileNames = [
            'wall.png', 'floor.png', 'crack.png', 'door.png',
            'skin1.png', 'skin2.png', 'skin3.png', 'skin4.png',
            'secret1.png', 'secret2.png', 'secret3.png',
            'btn_build.png', 'btn_ghost.png', 'btn_fog.png', 'btn_back.png'
        ];
        fileNames.forEach(f => {
            const img = new Image();
            img.src = 'assets/' + f;
            img.onload = () => assets[f] = img;
        });

        function loadAudio() {
            audio.menu = new Audio('assets/menu.mp3');
            audio.menu.loop = true;
            audio.step = new Audio('assets/step.mp3');
            audio.step.loop = true;
            audio.step.volume = 0.5;
        }
        loadAudio();

        function unlockAudio() {
            if (audioUnlocked) return;
            audioUnlocked = true;
            if (audio.menu) audio.menu.play().catch(() => {});
        }

        window.addEventListener('mousedown', unlockAudio);
        window.addEventListener('touchstart', unlockAudio);

        function showSkins() {
            state = 'skins';
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('skins-menu').style.display = 'flex';
            renderSkinGrid();
        }

        function showMenu() {
            state = 'menu';
            document.getElementById('skins-menu').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
        }

        function renderSkinGrid() {
            const grid = document.getElementById('skin-grid');
            grid.innerHTML = '';
            SKINS.forEach(s => {
                const div = document.createElement('div');
                div.className = 'skin-option';
                div.style.backgroundColor = s.color;
                if (assets[s.asset]) {
                    const img = document.createElement('img');
                    img.src = assets[s.asset].src;
                    div.appendChild(img);
                }
                div.onclick = () => selectSkin(s);
                grid.appendChild(div);
            });
            updateSkinPreview();
        }

        function selectSkin(s) {
            currentSkinColor = s.color;
            currentSkinImg = assets[s.asset] || null;
            updateSkinPreview();
        }

        function updateSkinPreview() {
            const p = document.getElementById('current-skin-preview');
            p.innerHTML = '';
            p.style.backgroundColor = currentSkinColor;
            if (currentSkinImg) {
                const img = document.createElement('img');
                img.src = currentSkinImg.src;
                p.appendChild(img);
            }
        }

        function loadCustomSkin(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = new Image();
                    img.src = ev.target.result;
                    img.onload = () => {
                        currentSkinImg = img;
                        updateSkinPreview();
                    };
                };
                reader.readAsDataURL(file);
            }
        }

        function startGame(buildMode) {
            unlockAudio();
            state = 'playing';
            isBuild = buildMode;
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            if (audio.menu) audio.menu.pause();
            initLevel();
        }

        function initLevel() {
            game.size = 21 + (level * 4);
            game.player = { x: 1.5, y: 1.5, r: 0.3 };
            game.map = genMaze(game.size);
            document.getElementById('lvl-display').innerText = '–£–†–û–í–ï–ù–¨: ' + level;
            renderBlockGrid();
        }

        function genMaze(size) {
            const map = Array.from({ length: size }, () => Array(size).fill(1));
            const walk = (x, y) => {
                map[y][x] = 0;
                const d = [[0, -2], [0, 2], [-2, 0], [2, 0]].sort(() => Math.random() - 0.5);
                for (const [dx, dy] of d) {
                    const nx = x + dx, ny = y + dy;
                    if (nx > 0 && nx < size - 1 && ny > 0 && ny < size - 1 && map[ny][nx] === 1) {
                        map[y + dy / 2][x + dx / 2] = Math.random() < 0.1 ? 2 : 0;
                        walk(nx, ny);
                    }
                }
            };
            walk(1, 1);
            let doorPlaced = false;
            while (!doorPlaced) {
                const rx = Math.floor(Math.random() * (size - 2)) + 1;
                const ry = Math.floor(Math.random() * (size - 2)) + 1;
                if (map[ry][rx] === 0 && (rx > size / 2 || ry > size / 2)) {
                    map[ry][rx] = 200; doorPlaced = true;
                }
            }
            return map;
        }

        function showSettings() {
            closeModals();
            document.getElementById('settings-modal').style.display = 'flex';
        }

        function showAmir() {
            closeModals();
            document.getElementById('amir-modal').style.display = 'flex';
            updateAmirButtons();
        }

        function closeModals() {
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        }

        function setMode(m) {
            isMobile = (m === 'mob');
            document.getElementById('joystick-base').style.display = isMobile ? 'block' : 'none';
            closeModals();
        }

        function updateAmirButtons() {
            const bBuild = document.getElementById('btn-toggle-build');
            const bGhost = document.getElementById('btn-toggle-ghost');
            const bFog = document.getElementById('btn-toggle-fog');

            const setBtn = (btn, imgName, text, active, colA, colI) => {
                btn.innerHTML = '';
                if (assets[imgName]) {
                    const img = document.createElement('img');
                    img.src = assets[imgName].src;
                    btn.appendChild(img);
                    btn.style.background = active ? colA : colI;
                } else {
                    btn.innerText = text + (active ? '–í–ö–õ' : '–í–´–ö–õ');
                    btn.className = 'amir-btn ' + (active ? colA : colI);
                }
            };

            setBtn(bBuild, 'btn_build.png', '–°–¢–†–û–ô–ö–ê: ', isBuild, 'btn-green', 'btn-red');
            setBtn(bGhost, 'btn_ghost.png', '–ü–†–ò–ó–†–ê–ö: ', isGhost, 'btn-purple', 'btn-purple');
            setBtn(bFog, 'btn_fog.png', '–¢–£–ú–ê–ù: ', isFog, 'btn-green', 'btn-orange');
        }

        function toggleBuild() { isBuild = !isBuild; updateAmirButtons(); }
        function toggleGhost() { isGhost = !isGhost; updateAmirButtons(); }
        function toggleFog() { isFog = !isFog; updateAmirButtons(); }

        function renderBlockGrid() {
            const grid = document.getElementById('block-grid');
            grid.innerHTML = '';
            B_TYPES.forEach(b => {
                const item = document.createElement('div');
                item.className = 'block-item' + (selectedBlock === b.id ? ' active' : '');
                item.style.backgroundColor = b.col;
                if (assets[b.img]) {
                    const img = document.createElement('img');
                    img.src = assets[b.img].src;
                    item.appendChild(img);
                }
                item.onclick = () => { selectedBlock = b.id; renderBlockGrid(); };
                grid.appendChild(item);
            });
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        window.addEventListener('keydown', e => { game.keys[e.key.toLowerCase()] = true; });
        window.addEventListener('keyup', e => { game.keys[e.key.toLowerCase()] = false; });

        canvas.addEventListener('mousedown', handlePointer);
        canvas.addEventListener('touchstart', e => handlePointer(e.touches[0]));

        function handlePointer(e) {
            if (state !== 'playing' || (document.querySelector('.modal').style.display === 'flex')) return;
            const ts = Math.min(canvas.width, canvas.height) / 7;
            const ox = canvas.width / 2 - game.player.x * ts;
            const oy = canvas.height / 2 - game.player.y * ts;
            const mx = Math.floor((e.clientX - ox) / ts), my = Math.floor((e.clientY - oy) / ts);
            
            if (isBuild && mx >= 0 && mx < game.size && my >= 0 && my < game.size) {
                game.map[my][mx] = selectedBlock;
            }
        }

        // –î–∂–æ–π—Å—Ç–∏–∫
        const jBase = document.getElementById('joystick-base');
        const jStick = document.getElementById('joystick-stick');
        window.addEventListener('touchmove', e => {
            if (!isMobile) return;
            const t = e.touches[0];
            const rect = jBase.getBoundingClientRect();
            const cx = rect.left + 60, cy = rect.top + 60;
            const dx = t.clientX - cx, dy = t.clientY - cy;
            const dist = Math.min(Math.hypot(dx, dy), 50);
            const ang = Math.atan2(dy, dx);
            game.joy.x = Math.cos(ang) * (dist / 50);
            game.joy.y = Math.sin(ang) * (dist / 50);
            jStick.style.transform = `translate(${game.joy.x * 40}px, ${game.joy.y * 40}px)`;
        });
        window.addEventListener('touchend', () => { game.joy = { x: 0, y: 0 }; jStick.style.transform = ''; });

        function loop() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if (state === 'playing') {
                update();
                draw();
            }
            requestAnimationFrame(loop);
        }

        function update() {
            let vx = game.joy.x * 0.15, vy = game.joy.y * 0.15;
            if (game.keys['w'] || game.keys['—Ü'] || game.keys['arrowup']) vy = -0.15;
            if (game.keys['s'] || game.keys['—ã'] || game.keys['arrowdown']) vy = 0.15;
            if (game.keys['a'] || game.keys['—Ñ'] || game.keys['arrowleft']) vx = -0.15;
            if (game.keys['d'] || game.keys['–≤'] || game.keys['arrowright']) vx = 0.15;

            const isMoving = Math.abs(vx) > 0.01 || Math.abs(vy) > 0.01;
            if (audioUnlocked && audio.step) {
                if (isMoving) { if (audio.step.paused) audio.step.play(); }
                else { audio.step.pause(); }
            }

            const check = (nx, ny) => {
                if (isGhost) return true;
                const r = game.player.r;
                const pts = [[nx-r, ny-r], [nx+r, ny-r], [nx-r, ny+r], [nx+r, ny+r]];
                for (const [px, py] of pts) {
                    const bx = Math.floor(px), by = Math.floor(py);
                    const b = game.map[by]?.[bx];
                    if (b === 1 || (b >= 101 && b <= 103)) return false;
                    if (b === 2) { game.map[by][bx] = 0; return true; }
                    if (b === 200) { level++; initLevel(); return false; }
                }
                return true;
            };

            if (check(game.player.x + vx, game.player.y)) game.player.x += vx;
            if (check(game.player.x, game.player.y + vy)) game.player.y += vy;
        }

        function draw() {
            const ts = Math.min(canvas.width, canvas.height) / 7;
            const ox = canvas.width / 2 - game.player.x * ts;
            const oy = canvas.height / 2 - game.player.y * ts;

            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            for (let y = 0; y < game.size; y++) {
                for (let x = 0; x < game.size; x++) {
                    const id = game.map[y][x];
                    if (assets['floor.png']) ctx.drawImage(assets['floor.png'], ox + x * ts, oy + y * ts, ts+1, ts+1);
                    if (id === 1) {
                        if (assets['wall.png']) ctx.drawImage(assets['wall.png'], ox+x*ts, oy+y*ts, ts, ts);
                        else { ctx.fillStyle = '#444'; ctx.fillRect(ox+x*ts, oy+y*ts, ts, ts); }
                    } else if (id === 2) {
                        if (assets['crack.png']) ctx.drawImage(assets['crack.png'], ox+x*ts, oy+y*ts, ts, ts);
                        else { ctx.fillStyle = '#8b4513'; ctx.fillRect(ox+x*ts, oy+y*ts, ts, ts); }
                    } else if (id === 200) {
                        if (assets['door.png']) ctx.drawImage(assets['door.png'], ox+x*ts, oy+y*ts, ts, ts);
                        else { ctx.fillStyle = '#f1c40f'; ctx.fillRect(ox+x*ts, oy+y*ts, ts, ts); }
                    } else if (id >= 101) {
                        const b = B_TYPES.find(bt => bt.id === id);
                        if (assets[b.img]) ctx.drawImage(assets[b.img], ox+x*ts, oy+y*ts, ts, ts);
                        else { ctx.fillStyle = b.col; ctx.fillRect(ox+x*ts, oy+y*ts, ts, ts); }
                    }
                }
            }

            const ps = ts * 0.8;
            if (currentSkinImg) ctx.drawImage(currentSkinImg, canvas.width/2 - ps/2, canvas.height/2 - ps/2, ps, ps);
            else { ctx.fillStyle = currentSkinColor; ctx.fillRect(canvas.width/2 - ts*0.3, canvas.height/2 - ts*0.3, ts*0.6, ts*0.6); }

            if (isFog) {
                const g = ctx.createRadialGradient(canvas.width/2, canvas.height/2, ts, canvas.width/2, canvas.height/2, ts*4);
                g.addColorStop(0, 'transparent'); g.addColorStop(1, 'rgba(0,0,0,0.95)');
                ctx.fillStyle = g; ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
        }

        loop();
    </script>
</body>
</html>